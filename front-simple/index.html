<html>
<head>
    <meta charset="utf-8"/>
</head>
<body>
<div>
    <form id="form">
        <input type="file" name="file"/>
        <select name="test_id" id="test-selector">
        </select>
        <button type=submit>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>
<div>
    <img src="./loading.gif" id="loading" style="display: none;"/>
</div>
<div>
    <pre id="error_output" ></pre>
    <b>–ö–æ–º–ø–∏–ª—è—Ü–∏—è:</b>
    <pre id="compiler_output" style="background: #010; padding: 10px;"></pre>
    <b>–¢–µ—Å—Ç—ã:</b>
    <pre id="runner_output" style="background: #010; padding: 10px;"></pre>
</div>
</body>
<script>
    const tty_to_html = tty =>
        tty
            .replace(/\[1;30m/g, "<font color='black'>")
            .replace(/\[1;31m/g, "<font color='#8b0000'>")
            .replace(/\[1;32m/g, "<font color='green'>")
            .replace(/\[1;33m/g, "<font color='yellow'>")
            .replace(/\[1;34m/g, "<font color='blue'>")
            .replace(/\[1;35m/g, "<font color='#8b008b'>")
            .replace(/\[1;36m/g, "<font color='#00ffff'>")
            .replace(/\[1;37m/g, "<font color='#d3d3d3'>")
            .replace(/\[1;90m/g, "<font color='#a9a9a9'>")
            .replace(/\[1;91m/g, "<font color='red'>")
            .replace(/\[1;92m/g, "<font color='#90ee90'>")
            .replace(/\[1;93m/g, "<font color='#ffffe0'>")
            .replace(/\[1;94m/g, "<font color='#add8e6'>")
            .replace(/\[1;95m/g, "<font color='#ff00ff'>")
            .replace(/\[1;96m/g, "<font color='#e0ffff'>")
            .replace(/\[1;97m/g, "<font color='white'>")
            .replace(/\[0m/g, "<font color='white'>");

    (async () => {
        const hide_loading = () => document.querySelector("#loading").style.display = 'none';
        const show_loading = () => document.querySelector("#loading").style.display = 'block';
        const compilerOutput = document.querySelector("#compiler_output");
        const runnerOutput = document.querySelector("#runner_output");
        const errorOutput = document.querySelector("#error_output");

        const form = document.querySelector("#form");
        form.onsubmit = async (event) => {
            event.preventDefault();

            compilerOutput.innerHTML = "";
            runnerOutput.innerHTML = "";
            errorOutput.innerHTML = "";

            const formData = new FormData(form);

            show_loading();

            const res = await fetch("http://127.0.0.1:3000/test_target/", {
                method: "POST",
                body: formData
            });

            hide_loading();

            const json = await res.json();
            console.log(json);

            if(json.error){
                errorOutput.innerHTML = JSON.stringify(json.error, null, 2);
            }

            const {data} = json;

            const {targetCompilation, testRunner} = data;

            compilerOutput.innerHTML = tty_to_html(targetCompilation.stdout);
            runnerOutput.innerHTML = tty_to_html(testRunner.stdout);
        };

        const testSelector = document.querySelector("#test-selector");
        const test_list = (await (await fetch("http://127.0.0.1:3000/list_tests/")).json()).data;
        testSelector.innerHTML += test_list.map(test => `<option value="${test}">${test}</option>`).join('\n');
    })();
</script>
</html>